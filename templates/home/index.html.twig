{% extends "base.html.twig" %}
{% block content %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
    <div id="map" style="height: 500px"></div>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        var mymap = L.map('map').setView([48.852969, 2.349903], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
        }).addTo(mymap); //création de la map

        var markers = L.markerClusterGroup();

        // parcourir le 1er fichier json afin d'afficher les marqueurs selon leurs latitudes et longitudes
        {% for station in response.data.stations %}
        var latitude = '{{ station.lat }}'; // on enregistre la latitude
        var longitude = '{{ station.lon }}'; // la longitude
        var marker = L.marker([latitude, longitude]);//.addTo(mymap); la variable marker contient les marqueurs créés en fonction de la latitude et la longitude. Mais il est inutile de l'ajouter à la map quand on les regroupe
        // parcourir le 2ᵉ fichier json pour récupérer le nom des stations, le nombre de vélos au total ainsi que le nombre de vélos électrique et mécanique précisément puis les afficher

        {% for st in response2.data.stations %}
        {% if st.station_id == station.station_id %} //nous lions l'id des stations à lui-même dans les 2 fichiers json (pour regrouper les infos d'une station précise même s'ils sont dans 2 fichiers json)
        marker.bindPopup('<form action="/favoritestations" method="post">' +
            "Nom : {{ station.name }}" +
            "<input type='hidden' id='nomStations' name='nomStations' value='{{ station.name }}'>" +
            " <br> Nombres vélos total : {{ st.numBikesAvailable }}" +
            " <br> Nombre vélos électriques : {{ st.num_bikes_available_types[1].ebike }}" +
            "<br> Nombre de vélos mécaniques : {{ st.num_bikes_available_types[0].mechanical }}" +
            "<input type='hidden' id='idStations' name='idStations' value='{{ station.station_id }}'>" +
            "<br>" +
            '<button type="submit" id="favori" name="favori">Ajouter au favori</button></form>');
        markers.addLayer(marker); //les marqueurs sont ajoutés au groupe
        {% endif %}
        {% endfor %}

        {% endfor %}

        mymap.addLayer(markers) //Après avoir créé les marqueurs, avoir défini ce qu'ils afficheront, et les avoir ajoutés au groupe "markers", on ajoute ce même groupe à la carte. Les marqueurs sont désormais affichés et organisés

    </script>

    <button class="btn btn-outline-dark" id="geolocate">Géolocalisez-moi</button>
    <script>
        document.getElementById('geolocate').addEventListener('click', function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) { // nous obtenons la position
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const marker = L.marker([lat, lng]).addTo(mymap); //on ajoute le marqueur qui contient nos coordonnées
                    marker.bindPopup('Vous êtes ici !').openPopup(); //on l'affiche
                    mymap.setView([lat, lng], 13);
                }, function (error) {
                    alert('Erreur lors de géolocalisation : ' + error.message);
                });
            } else {
                alert('La géolocalisation n\'est pas prise en charge par votre navigateur.');
            }
        });
    </script>

    <form action="{{ ('compte') }}" method="get"> {# permet de naviguer vers compte #}
        <button class="btn btn-outline-dark" type="submit">Espace compte</button>
    </form>
    <form action="{{ ('favoritestations') }}" method="get"> {# permet de naviguer vers favoritestations #}
        <button class="btn btn-outline-dark" type="submit">Mes stations préférées</button>
    </form>

{% endblock %}
